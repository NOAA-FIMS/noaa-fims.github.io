name: Screenshot Weekly Page and Email

on:
  workflow_run:
    workflows: ["pages-build-deployment"]
    types:
      - completed

jobs:
  screenshot_and_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install puppeteer

      - name: Find newly added weekly HTML files
        id: added_html
        run: |
          ADDED_FILES=$(git diff --name-status HEAD~1 HEAD | awk '/^A/ && $2 ~ /^docs\/fims-weekly\/.*\.html$/ {print $2}')
          echo "ADDED_FILES=$ADDED_FILES" >> $GITHUB_ENV
          echo "$ADDED_FILES" > added_html.txt
          echo "$ADDED_FILES"

      - name: Screenshot new weekly page
        if: env.ADDED_FILES != ''
        run: |
          while read html_file; do
            if [ -f "$html_file" ]; then
              node .github/screenshot.js "$html_file"
            else
              echo "HTML file $html_file not found."
            fi
          done < added_html.txt

      - name: Check that png was created
        if: env.ADDED_FILES != ''
        run: |
          echo "Listing only the generated .png files..."
          ls -l *.png

      - name: Send email
        if: env.ADDED_FILES != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: Github Actions job result
          to: elizabeth.gugliotti@noaa.gov,kelli.johnson@noaa.gov
          from: FIMS Weekly GitHub
          content_type: text/html
          body: Here is a screenshot of this week's FIMS Weekly page.
          attachments: screenshot.png